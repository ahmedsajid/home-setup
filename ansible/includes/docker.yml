---

- name: "Docker installation and setup"
  hosts: localhost
  connection: local
  handlers:
    - name: Restart docker
      systemd:
        name: "docker"
        state: restarted
      # Skipping check mode since its causes issues :(
      when: not ansible_check_mode
  tasks:
    - name: Gather package facts
      package_facts:

    - name: create role folder
      file:
        state: directory
        path: /root/.ansible/roles

    - name: Clone role gbolo.docker
      git:
        repo: 'https://github.com/gbolo/ansible-role-docker.git'
        dest: /root/.ansible/roles/gbolo.docker
        version: v2.1
      # added retry to tasks dependant on external services
      register: result
      retries: 5
      delay: 3
      until: result is succeeded

    - name: Using docker role
      include_role:
        name: gbolo.docker
      vars:
        docker_config_log_opts: {
          "max-size": "100m",
          "max-file": "5"
        }
        docker_install_py_module: true
        docker_py_pkg_name: "python3-docker"
        docker_config_bip: "172.16.0.1/24"
        docker_config_fixed_cidr: "172.16.0.0/24"
      when: not ansible_check_mode

    - name: Setup docker app network
      docker_network:
        name: app_network
